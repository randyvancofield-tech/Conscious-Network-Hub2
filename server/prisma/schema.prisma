// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SocialPostVisibility {
  public
  private
}

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  name          String?
  handle        String?
  bio           String?
  location      String?
  dateOfBirth   DateTime?
  avatarUrl     String?
  bannerUrl     String?
  profileMedia  Json?
  interests     Json?
  twitterUrl    String?
  githubUrl     String?
  websiteUrl    String?
  privacySettings Json?
  password      String
  passwordFingerprint String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Membership fields
  tier          String     @default("Free / Community Tier")
  subscriptionStatus String @default("inactive")
  subscriptionStartDate DateTime?
  subscriptionEndDate DateTime?

  // Profile customization
  profileBackgroundVideo String?
  phoneNumber    String?
  twoFactorMethod String  @default("none")
  walletDid      String?
  pendingPhoneOtpHash String?
  pendingPhoneOtpExpiresAt DateTime?
  pendingPhoneOtpAttempts Int @default(0)
  failedSignInAttempts Int @default(0)
  lockoutUntil   DateTime?

  // Relations
  memberships   Membership[]
  payments      PaymentHistory[]
  reflections   Reflection[]
  socialPosts   SocialPost[]
  socialLikes   SocialPostLike[]
  following     SocialFollow[] @relation("SocialFollowFollower")
  followers     SocialFollow[] @relation("SocialFollowFollowing")

  @@index([createdAt])
}

model Reflection {
  id          String   @id @default(uuid())
  userId      String
  content     String?
  fileUrl     String
  fileType    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model Membership {
  id            String     @id @default(uuid())
  userId        String
  tier          String
  status        String     @default("active")
  startDate     DateTime   @default(now())
  endDate       DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments      PaymentHistory[]

  @@unique([userId])
  @@index([createdAt])
}

model PaymentHistory {
  id            String     @id @default(uuid())
  userId        String
  membershipId  String
  amount        Float
  currency      String     @default("USD")
  tier          String
  status        String     @default("completed")
  paymentMethod String     @default("mock")
  description   String?
  createdAt     DateTime   @default(now())

  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  membership    Membership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model ProviderChallenge {
  id        String   @id
  did       String
  nonce     String
  statement String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([did])
  @@index([expiresAt])
}

model ProviderSession {
  id         String   @id
  did        String
  scopesJson String
  issuedAt   DateTime
  expiresAt  DateTime
  revokedAt  DateTime?
  createdAt  DateTime @default(now())

  @@index([did])
  @@index([expiresAt])
  @@index([revokedAt])
}

model SocialPost {
  id         String          @id
  authorId   String
  text       String
  visibility SocialPostVisibility @default(public)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  author     User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  media      SocialPostMedia[]
  likes      SocialPostLike[]

  @@index([authorId])
  @@index([createdAt])
}

model SocialPostMedia {
  id              String     @id
  postId          String
  mediaType       String
  url             String
  storageProvider String?
  objectKey       String?
  createdAt       DateTime   @default(now())

  post            SocialPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model SocialPostLike {
  userId    String
  postId    String
  createdAt DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      SocialPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([userId, postId])
  @@index([postId])
  @@index([createdAt])
}

model SocialFollow {
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower    User     @relation("SocialFollowFollower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("SocialFollowFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@id([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@index([createdAt])
}
